<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Â∞èÂ∑•ÂÖ∑</title>
  <style>
    body {
      background-color: #333;
      color: #fff;
      font-family: Arial, sans-serif;
      font-size: 16px;
      padding: 20px;
    }

    .input-container {
      margin: 20px 0;
      text-align: center;
    }

    #numberInput {
      width: 200px;
      height: 40px;
      font-size: 18px;
      padding: 5px;
      margin-right: 10px;
      background-color: #444;
      color: #fff;
      border: 1px solid #555;
      border-radius: 5px;
    }

    #numberInput::placeholder {
      color: #aaa;
    }

    #confirmBtn {
      height: 40px;
      font-size: 18px;
      padding: 0 20px;
      background-color: #555;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #confirmBtn:hover {
      background-color: #777;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      color: #fff;
    }

    th, td {
      border: 1px solid #555;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #444;
    }

    tr {
      background-color: #222;
      transition: background-color 0.3s ease;
    }

    tr:hover {
      background-color: #333;
    }

    tr.lightgreen {
      background-color: #006400;
    }

    tr.darkred {
      background-color: #530505;
    }

    .resetBtn, .deleteBtn {
      background-color: #555;
      color: #fff;
      border: none;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
    }

    .resetBtn:hover, .deleteBtn:hover {
      background-color: #777;
    }

    #errorMessage {
      color: red;
      text-align: center;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      #numberInput, #confirmBtn {
        width: 100%;
        margin-top: 10px;
      }

      .input-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <!-- Help icon (top-right) with hover popup -->
  <div class="help-widget" title="ü•µ">
    <!-- Ant Design style QuestionCircle icon (inline SVG) -->
    <svg class="help-icon" viewBox="64 64 896 896" focusable="false" aria-hidden="true">
      <path fill="currentColor" d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372S306.6 140 512 140s372 166.6 372 372-166.6 372-372 372z"/>
      <path fill="currentColor" d="M518 690a44 44 0 1 0 0 88 44 44 0 0 0 0-88zm-6-470c-61.9 0-112.5 18.3-151.7 54.8-32.3 30.1-49.3 64.5-51.2 103.2-.2 4.1 3.1 7.5 7.2 7.5h73.9c3.7 0 6.8-2.7 7.2-6.4 4.9-49.7 41.3-74.6 114.6-74.6 29.7 0 53.2 6.5 70.4 19.6 17.1 12.9 25.7 30.3 25.7 52.2 0 20.6-6.1 37.4-18.3 50.5-12.1 12.9-32.1 25.6-60 38.1-35.4 15.9-61 33.5-76.7 52.8-15.6 19-23.4 44.2-23.4 75.5v18.6c0 4 3.2 7.2 7.2 7.2h72.5c4 0 7.2-3.2 7.2-7.2v-14.9c0-22.9 5.8-41 17.5-54.3 11.5-13.1 31.9-25.7 61.1-37.8 33.7-14.2 58.6-31.8 74.8-52.9 16.3-21.3 24.4-46.8 24.4-76.6 0-44.5-16.1-80.1-48.1-106.9C636.2 235.1 584.5 220 512 220z"/>
    </svg>
    <div class="help-popup">
      <!-- Replace the image URL with your tutorial screenshot/site image -->
      <img src="https://media.discordapp.net/attachments/1412678781453467739/1412679764959035412/image0.jpg?ex=68b92c0e&is=68b7da8e&hm=88b6aa662ac692e5694da2db40a6236bff5830eb10a647813c6e90e2292b3a8e&=&format=webp"
      alt="ÊïôÂ≠∏" />
    </div>
  </div>

  <div class="input-container">
    <input type="number" id="numberInput" placeholder="Ëº∏ÂÖ•Êï∏Â≠ó" />
    <button id="confirmBtn">Á¢∫ÂÆö</button>
  </div>
  <div id="errorMessage"></div>
  <table id="dataTable">
    <thead>
      <tr>
        <th>È†ªÈÅì</th>
        <th>ÊôÇÈñì</th>
        <th>ÊôÇÈñì +45ÂàÜ</th>
        <th>ÊôÇÈñì +1Â∞èÊôÇ8ÂàÜ</th>
        <th>ÈáçÁΩÆ</th>
        <th>Âà™Èô§</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onValue,
      update,
      remove,
      get
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCW3OnDcUJufnBheW2dNIp1n56I_F0u3YI",
      authDomain: "time-tool-510c6.firebaseapp.com",
      databaseURL: "https://time-tool-510c6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "time-tool-510c6",
      storageBucket: "time-tool-510c6.appspot.com",
      messagingSenderId: "39463921944",
      appId: "1:39463921944:web:f3237fd5c26a60e6dcd66d"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const input = document.getElementById('numberInput');
    const errorMessage = document.getElementById('errorMessage');
    const tbody = document.querySelector('#dataTable tbody');

    document.getElementById('confirmBtn').addEventListener('click', async () => {
      const number = input.value;
      if (!number) {
        errorMessage.textContent = 'Ë´ãËº∏ÂÖ•Êï∏Â≠ó';
        return;
      }

      const now = new Date();
      const data = {
        number,
        confirmTime: formatTime(now),
        plus45Min: formatTime(addMinutes(now, 45)),
        plus1Hr8Min: formatTime(addMinutes(now, 68)),
        date: now.toDateString()
      };

      try {
        await push(ref(database, 'rows'), data);
        input.value = '';
        errorMessage.textContent = '';
      } catch (error) {
        errorMessage.textContent = 'ÁÑ°Ê≥ïÂÑ≤Â≠òÊï∏Êìö: ' + error.message;
        console.error(error);
      }
    });

    onValue(ref(database, 'rows'), (snapshot) => {
      tbody.innerHTML = '';
      snapshot.forEach((child) => {
        const data = child.val();
        const row = document.createElement('tr');
        row.dataset.date = data.date;
        row.dataset.key = child.key;

        row.innerHTML = `
          <td>${data.number}</td>
          <td>${data.confirmTime}</td>
          <td>${data.plus45Min}</td>
          <td>${data.plus1Hr8Min}</td>
          <td><button class="resetBtn" data-key="${child.key}">ÈáçÁΩÆ</button></td>
          <td><button class="deleteBtn" data-key="${child.key}">Âà™Èô§</button></td>
        `;
        tbody.appendChild(row);
      });
    }, (error) => {
      errorMessage.textContent = 'ÁÑ°Ê≥ïËÆÄÂèñÊï∏Êìö: ' + error.message;
      console.error(error);
    });

    tbody.addEventListener('click', async (e) => {
      const key = e.target.dataset.key;
      if (!key) return;

      const rowRef = ref(database, 'rows/' + key);

      if (e.target.classList.contains('resetBtn')) {
        const now = new Date();
        const updated = {
          number: (await get(rowRef)).val().number, // ‰øùÁïôÂéüÂßãÊï∏Â≠ó
          confirmTime: formatTime(now),
          plus45Min: formatTime(addMinutes(now, 45)),
          plus1Hr8Min: formatTime(addMinutes(now, 68)),
          date: now.toDateString()
        };

        try {
          // ÂÖàÁßªÈô§ÂéüÊï∏Êìö
          await remove(rowRef);
          // ÈáçÊñ∞ push ‰ª•Á¢∫‰øùÊñ∞Êï∏ÊìöÂú® rows Êú´Â∞æ
          await push(ref(database, 'rows'), updated);
          errorMessage.textContent = '';
        } catch (error) {
          errorMessage.textContent = 'ÁÑ°Ê≥ïÈáçÁΩÆÊï∏Êìö: ' + error.message;
          console.error(error);
        }
      }

      if (e.target.classList.contains('deleteBtn')) {
        try {
          await remove(rowRef);
          errorMessage.textContent = '';
        } catch (error) {
          errorMessage.textContent = 'ÁÑ°Ê≥ïÂà™Èô§Êï∏Êìö: ' + error.message;
          console.error(error);
        }
      }
    });

    setInterval(() => {
      const now = new Date();
      document.querySelectorAll('#dataTable tbody tr').forEach(row => {
        const baseDate = new Date(row.dataset.date);
        const plus45 = parseTime(row.cells[2].textContent, baseDate);
        const plus68 = parseTime(row.cells[3].textContent, baseDate);

        row.classList.remove('lightgreen', 'darkred');
        if (now >= plus68) {
          row.classList.add('darkred');
        } else if (now >= plus45) {
          row.classList.add('lightgreen');
        }
      });
    }, 1000);

    function formatTime(date) {
      return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    function addMinutes(date, mins) {
      const d = new Date(date);
      d.setMinutes(d.getMinutes() + mins);
      return d;
    }

    function parseTime(str, baseDate) {
      const [h, m] = str.split(':').map(Number);
      const d = new Date(baseDate);
      d.setHours(h, m, 0, 0);
      return d;
    }
  </script>
  <style>
    .help-widget {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 1000;
    }
    .help-icon {
      width: 28px;
      height: 28px;
      color: #ccc;
      cursor: pointer;
      transition: color .2s ease;
    }
    .help-widget:hover .help-icon {
      color: #fff;
    }
    .help-popup {
      position: absolute;
      top: 36px;
      right: 0;
      display: none;
      background: #111;
      border: 1px solid #444;
      border-radius: 8px;
      box-shadow: 0 6px 20px rgba(0,0,0,.4);
      padding: 8px;
      /* Allow larger content for the tutorial image */
      max-width: none;
      max-height: none;
      overflow: auto;
    }
    .help-popup img {
      height: 600px;
      width: auto;
      display: block;
    }
    .help-widget:hover .help-popup {
      display: block;
    }
  </style>
</body>
</html>
