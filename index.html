<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>小工具</title>
  <style>
    body {
      background-color: #333;
      color: #fff;
      font-family: Arial, sans-serif;
      font-size: 16px;
      padding: 20px;
    }

    .input-container {
      margin: 20px 0;
      text-align: center;
    }

    #numberInput {
      width: 200px;
      height: 40px;
      font-size: 18px;
      padding: 5px;
      margin-right: 10px;
      background-color: #444;
      color: #fff;
      border: 1px solid #555;
      border-radius: 5px;
    }

    #numberInput::placeholder {
      color: #aaa;
    }

    #confirmBtn {
      height: 40px;
      font-size: 18px;
      padding: 0 20px;
      background-color: #555;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    #confirmBtn:hover {
      background-color: #777;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      color: #fff;
    }

    th, td {
      border: 1px solid #555;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #444;
    }

    tr {
      background-color: #222;
      transition: background-color 0.3s ease;
    }

    tr:hover {
      background-color: #333;
    }

    tr.lightgreen {
      background-color: #006400;
    }

    tr.darkred {
      background-color: #530505;
    }

    .resetBtn, .deleteBtn {
      background-color: #555;
      color: #fff;
      border: none;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
    }

    .resetBtn:hover, .deleteBtn:hover {
      background-color: #777;
    }

    #errorMessage {
      color: red;
      text-align: center;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      #numberInput, #confirmBtn {
        width: 100%;
        margin-top: 10px;
      }

      .input-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="input-container">
    <input type="number" id="numberInput" placeholder="輸入數字" />
    <button id="confirmBtn">確定</button>
  </div>
  <div id="errorMessage"></div>
  <table id="dataTable">
    <thead>
      <tr>
        <th>頻道</th>
        <th>時間</th>
        <th>時間 +45分</th>
        <th>時間 +1小時8分</th>
        <th>重置</th>
        <th>刪除</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onValue,
      update,
      remove,
      get
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCW3OnDcUJufnBheW2dNIp1n56I_F0u3YI",
      authDomain: "time-tool-510c6.firebaseapp.com",
      databaseURL: "https://time-tool-510c6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "time-tool-510c6",
      storageBucket: "time-tool-510c6.appspot.com",
      messagingSenderId: "39463921944",
      appId: "1:39463921944:web:f3237fd5c26a60e6dcd66d"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const input = document.getElementById('numberInput');
    const errorMessage = document.getElementById('errorMessage');
    const tbody = document.querySelector('#dataTable tbody');

    document.getElementById('confirmBtn').addEventListener('click', async () => {
      const number = input.value;
      if (!number) {
        errorMessage.textContent = '請輸入數字';
        return;
      }

      const now = new Date();
      const data = {
        number,
        confirmTime: formatTime(now),
        plus45Min: formatTime(addMinutes(now, 45)),
        plus1Hr8Min: formatTime(addMinutes(now, 68)),
        date: now.toDateString()
      };

      try {
        await push(ref(database, 'rows'), data);
        input.value = '';
        errorMessage.textContent = '';
      } catch (error) {
        errorMessage.textContent = '無法儲存數據: ' + error.message;
        console.error(error);
      }
    });

    onValue(ref(database, 'rows'), (snapshot) => {
      tbody.innerHTML = '';
      snapshot.forEach((child) => {
        const data = child.val();
        const row = document.createElement('tr');
        row.dataset.date = data.date;
        row.dataset.key = child.key;

        row.innerHTML = `
          <td>${data.number}</td>
          <td>${data.confirmTime}</td>
          <td>${data.plus45Min}</td>
          <td>${data.plus1Hr8Min}</td>
          <td><button class="resetBtn" data-key="${child.key}">重置</button></td>
          <td><button class="deleteBtn" data-key="${child.key}">刪除</button></td>
        `;
        tbody.appendChild(row);
      });
    }, (error) => {
      errorMessage.textContent = '無法讀取數據: ' + error.message;
      console.error(error);
    });

    tbody.addEventListener('click', async (e) => {
      const key = e.target.dataset.key;
      if (!key) return;

      const rowRef = ref(database, 'rows/' + key);

      if (e.target.classList.contains('resetBtn')) {
        const now = new Date();
        const updated = {
          number: (await get(rowRef)).val().number, // 保留原始數字
          confirmTime: formatTime(now),
          plus45Min: formatTime(addMinutes(now, 45)),
          plus1Hr8Min: formatTime(addMinutes(now, 68)),
          date: now.toDateString()
        };

        try {
          // 先移除原數據
          await remove(rowRef);
          // 重新 push 以確保新數據在 rows 末尾
          await push(ref(database, 'rows'), updated);
          errorMessage.textContent = '';
        } catch (error) {
          errorMessage.textContent = '無法重置數據: ' + error.message;
          console.error(error);
        }
      }

      if (e.target.classList.contains('deleteBtn')) {
        try {
          await remove(rowRef);
          errorMessage.textContent = '';
        } catch (error) {
          errorMessage.textContent = '無法刪除數據: ' + error.message;
          console.error(error);
        }
      }
    });

    setInterval(() => {
      const now = new Date();
      document.querySelectorAll('#dataTable tbody tr').forEach(row => {
        const baseDate = new Date(row.dataset.date);
        const plus45 = parseTime(row.cells[2].textContent, baseDate);
        const plus68 = parseTime(row.cells[3].textContent, baseDate);

        row.classList.remove('lightgreen', 'darkred');
        if (now >= plus68) {
          row.classList.add('darkred');
        } else if (now >= plus45) {
          row.classList.add('lightgreen');
        }
      });
    }, 1000);

    function formatTime(date) {
      return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    function addMinutes(date, mins) {
      const d = new Date(date);
      d.setMinutes(d.getMinutes() + mins);
      return d;
    }

    function parseTime(str, baseDate) {
      const [h, m] = str.split(':').map(Number);
      const d = new Date(baseDate);
      d.setHours(h, m, 0, 0);
      return d;
    }
  </script>
</body>
</html>
